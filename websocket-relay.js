var express=require("express"),app=express(),http=require("http"),ws=require("ws"),httpServer=http.Server(app),io=require("socket.io")(httpServer),httpProxy=require("http-proxy"),RtspStreamList=require("rtsp-stream-list"),rtspStreamList=new RtspStreamList(io),port=18081,RTSPS=process.env.RTSPS||"",rtsps=RTSPS.split("|"),r;for(r in rtsps)rtsps[r]="add "+rtsps[r];
var STREAM_SECRET=process.argv[2]||"supersecret",STREAM_PORT=process.argv[3]||18082,WEBSOCKET_PORT=process.argv[4]||18083,RECORD_STREAM=!1,proxy=httpProxy.createProxyServer({});proxy.on("error",function(a,b,c){c.writeHead(500,{"Content-Type":"text/plain"});c.end("Something went wrong. And we are reporting a custom error message.")});
app.get("/eye/*",function(a,b){var c=a.headers.host;console.log("client ip:"+(a.headers["x-forwarded-for"]||a.connection.remoteAddress)+", host:"+c);switch(c){case "solr.qhkly.com":case "neo4j.qhkly.com":proxy.web(a,b,{target:"http://192.168.0.96:8008/eye/"});break;default:b.writeHead(200,{"Content-Type":"text/plain"}),b.end("Welcome to my server!")}});app.use(express["static"]("static"));app.get("/",function(a,b){b.sendFile(__dirname+"/index.html")});
io.on("connection",function(a){console.log("a user connected");a.emit("get room");a.on("subscribe",function(b){console.log("subscribe "+b.room);a.join(b.room)});a.on("unsubscribe",function(b){console.log("unsubscribe "+b.room);a.leave(b.room)});a.on("disconnect",function(){console.log("user disconnected")});a.on("chat message",function(b){for(var c in a.rooms)c!=a.id&&(console.log(b),io.to(c).emit("chat message",b),rtspStreamList.verifyStartupVideoStream(b,c))})});
httpServer.listen(port,function(){console.log("listening on *:"+port)});for(var r$0 in rtsps){var rtsp=rtsps[r$0];rtspStreamList.verifyStartupVideoStream(rtsp,"rtsp")}
var streamServer=http.createServer(function(a,b){var c=a.url.substr(1).split("/");console.log(c);console.log("++++++++++++++++++++++++++++++++++");if(!c[0].startsWith(STREAM_SECRET)||c[0].length<=STREAM_SECRET.length)console.log("Failed Stream Connection: "+a.socket.remoteAddress+":"+a.socket.remotePort+" - wrong secret."),b.end();b.connection.setTimeout(0);console.log("Stream Connected: "+a.socket.remoteAddress+":"+a.socket.remotePort);a.on("data",function(b){var d=parseInt(c[0].substring(STREAM_SECRET.length,
c[0].length));rtspStreamList.sendVideoStream(d,b);a.socket.recording&&a.socket.recording.write(b)});a.on("end",function(){console.log("close");a.socket.recording&&a.socket.recording.close()});if(RECORD_STREAM){var d="recordings/"+Date.now()+".ts";a.socket.recording=fs.createWriteStream(d)}}).listen(STREAM_PORT);console.log("Listening for incomming MPEG-TS Stream on http://127.0.0.1:"+STREAM_PORT+"/<secret>");var socketServer=new ws.Server({port:WEBSOCKET_PORT,perMessageDeflate:!1});
socketServer.connectionCount=0;socketServer.on("connection",function(a,b){socketServer.connectionCount++;console.log("New WebSocket Connection: ",(b||a.upgradeReq).socket.remoteAddress,(b||a.upgradeReq).headers["user-agent"],"("+socketServer.connectionCount+" total)");a.on("close",function(a,b){socketServer.connectionCount--;console.log("Disconnected WebSocket ("+socketServer.connectionCount+" total)")})});
socketServer.broadcast=function(a){socketServer.clients.forEach(function(b){b.readyState===ws.OPEN&&b.send(a)})};console.log("Awaiting WebSocket connections on ws://127.0.0.1:"+WEBSOCKET_PORT+"/");